<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« - Vulnerable Shop</title>
  <link rel="stylesheet" href="./styles.css"/>
  <style>
    .page-wrap{max-width:920px;margin:32px auto;padding:0 16px}
    .card{background:#0f1b31;border:1px solid #27334d;border-radius:12px;padding:16px;margin-bottom:18px}
    .grid{display:grid;gap:12px}
    .grid.two{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.three{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid > label{display:grid;gap:6px;font-weight:600}
    .grid input,.grid textarea,select{
      background:#0b1426;border:1px solid #2c3a59;color:#eaf2ff;border-radius:10px;padding:10px 12px;outline:none
    }
    textarea{min-height:96px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .muted{opacity:.8}
    .ok{color:#69f0ae}.err{color:#ff6b6b}
    .avatar{width:72px;height:72px;border-radius:50%;object-fit:cover;border:1px solid #2c3a59}
  </style>
</head>
<body>
<header class="navbar">
  <div class="nav-brand"><h1>ğŸ›’ Vulnerable Shop</h1></div>
  <div class="nav-links">
    <a href="./index.html">ãƒ›ãƒ¼ãƒ </a>
    <a href="./products.html">å•†å“</a>
    <a href="./cart.html">ã‚«ãƒ¼ãƒˆ <span id="cartCount" class="cart-badge">0</span></a>
    <a href="./java-vuln.html" style="color:#ffd700;font-weight:bold;">Javaè„†å¼±æ€§ãƒ‡ãƒ¢</a>
    <a href="./profile.html" aria-current="page" style="font-weight:700">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
    <div class="auth-buttons">
      <button id="logoutBtn" class="btn btn-danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>
</header>

<main class="page-wrap">
  <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
  <p class="muted">â€» æ•™è‚²ç”¨ã‚µã‚¤ãƒˆã®ãŸã‚å…¥åŠ›ã¯æœ€å°é™ã®æ¤œè¨¼ã§ã™ã€‚</p>

  <div id="msg" class="muted" style="margin:10px 0;"></div>

  <div class="card">
    <div class="row" style="align-items:center;">
      <img id="avatarPreview" class="avatar" src="https://i.pravatar.cc/72?img=12" alt="">
      <div id="headerName" style="font-size:18px;font-weight:700">-</div>
    </div>
  </div>

  <form id="profileForm" class="card">
    <h3>åŸºæœ¬æƒ…å ±</h3>
    <div class="grid two">
      <label>è¡¨ç¤ºå <input name="display_name" placeholder="ä¾‹ï¼šãŸã‚ã†"></label>
      <label>æ°åï¼ˆãƒ•ãƒ«ãƒãƒ¼ãƒ ï¼‰ <input name="full_name" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ"></label>
      <label>ãƒ¡ãƒ¼ãƒ« <input name="email" type="email" placeholder="user@example.com"></label>
      <label>é›»è©±ç•ªå· <input name="phone" placeholder="090-xxxx-xxxx"></label>
      <label>èª•ç”Ÿæ—¥ <input name="birthday" type="date"></label>
      <label>Webã‚µã‚¤ãƒˆ <input name="website" placeholder="https://example.com"></label>
    </div>

    <h3 style="margin-top:16px">ä½æ‰€</h3>
    <div class="grid three">
      <label>å›½ <input name="country" placeholder="Japan"></label>
      <label>éƒ½é“åºœçœŒ <input name="state" placeholder="æ±äº¬éƒ½"></label>
      <label>å¸‚åŒºç”ºæ‘ <input name="city" placeholder="åƒä»£ç”°åŒº"></label>
    </div>
    <div class="grid two" style="margin-top:12px">
      <label>ä½æ‰€1 <input name="address1" placeholder="ä¸¸ã®å†…1-1-1"></label>
      <label>ä½æ‰€2 <input name="address2" placeholder="å»ºç‰©åãƒ»éƒ¨å±‹ç•ªå· ç­‰"></label>
    </div>
    <div class="grid two" style="margin-top:12px">
      <label>éƒµä¾¿ç•ªå· <input name="zip" placeholder="100-0005"></label>
      <label>ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ <input name="timezone" placeholder="Asia/Tokyo"></label>
    </div>

    <h3 style="margin-top:16px">ãã®ä»–</h3>
    <div class="grid">
      <label>è‡ªå·±ç´¹ä»‹ <textarea name="bio" placeholder="ã²ã¨ã“ã¨ã©ã†ã"></textarea></label>
      <label>ã‚¢ãƒã‚¿ãƒ¼ç”»åƒURL <input name="avatar_url" placeholder="https://..."></label>
      <label>Twitter(X) <input name="twitter" placeholder="@yourid"></label>
      <label>è¨€èª <input name="language" placeholder="ja-JP"></label>
      <label>ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ¬ã‚¿ãƒ¼
        <select name="newsletter"><option value="0">å—ã‘å–ã‚‰ãªã„</option><option value="1">å—ã‘å–ã‚‹</option></select>
      </label>
    </div>

    <div class="row" style="margin-top:14px">
      <button class="btn btn-primary" type="submit">ä¿å­˜</button>
      <button class="btn" type="button" id="reloadBtn">å†èª­è¾¼</button>
    </div>
  </form>

  <form id="passwordForm" class="card">
    <h3>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
    <div class="grid two">
      <label>ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <input name="current" type="password" required></label>
      <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <input name="next" type="password" required></label>
    </div>
    <div class="row" style="margin-top:14px">
      <button class="btn btn-warning" type="submit">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°</button>
    </div>
  </form>
</main>

<script>
  const $ = s => document.querySelector(s);
  function authHeaders(){
    const t = localStorage.getItem('token') || '';
    return { 'Content-Type':'application/json', ...(t?{Authorization:'Bearer '+t}:{}) };
  }
  function setMsg(t, ok=false){ const el=$('#msg'); el.textContent=t; el.className = ok?'ok':'err'; }
  function clearMsg(){ const el=$('#msg'); el.textContent=''; el.className='muted'; }

  async function loadProfile(){
    clearMsg();
    const t = localStorage.getItem('token');
    if(!t){ setMsg('æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™'); return; }
    try{
      const r = await fetch('/api/me', {headers: authHeaders()});
      const d = await r.json();
      if(!r.ok) throw new Error(d.error||r.statusText);

      $('#headerName').textContent = (d.profile?.display_name || d.user?.username || '-');
      $('#avatarPreview').src = d.profile?.avatar_url || 'https://i.pravatar.cc/72?img=12';

      const f = $('#profileForm');
      Object.entries(d.profile||{}).forEach(([k,v])=>{
        if (k in f.elements) f.elements[k].value = v ?? '';
      });
      if (f.elements.email && d.user?.email) f.elements.email.value = d.user.email;
    }catch(e){ setMsg('èª­ã¿è¾¼ã¿å¤±æ•—: '+e.message); }
  }

  $('#profileForm').addEventListener('submit', async (e)=>{
    e.preventDefault(); clearMsg();
    const t = localStorage.getItem('token');
    if(!t){ setMsg('æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™'); return; }
    const f=e.currentTarget;
    const payload = Object.fromEntries(new FormData(f).entries());
    try{
      const r = await fetch('/api/me', {method:'PUT', headers:authHeaders(), body:JSON.stringify(payload)});
      const d = await r.json();
      if(!r.ok) throw new Error(d.error||r.statusText);
      setMsg('ä¿å­˜ã—ã¾ã—ãŸ', true);
      $('#headerName').textContent = payload.display_name || $('#headerName').textContent;
      if(payload.avatar_url) $('#avatarPreview').src = payload.avatar_url;
    }catch(e){ setMsg('ä¿å­˜å¤±æ•—: '+e.message); }
  });

  $('#reloadBtn').addEventListener('click', loadProfile);

  $('#passwordForm').addEventListener('submit', async (e)=>{
    e.preventDefault(); clearMsg();
    const cur = e.currentTarget.elements.current.value;
    const next = e.currentTarget.elements.next.value;
    if(!cur || !next){ setMsg('å…¥åŠ›ä¸è¶³'); return; }
    try{
      const r = await fetch('/api/me/password', {
        method:'PUT', headers:authHeaders(),
        body:JSON.stringify({ current:cur, next })
      });
      const d = await r.json();
      if(!r.ok) throw new Error(d.error||d.message||r.statusText);
      setMsg('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ', true);
      e.currentTarget.reset();
    }catch(e){ setMsg('æ›´æ–°å¤±æ•—: '+e.message); }
  });

  $('#logoutBtn').addEventListener('click', ()=>{
    localStorage.removeItem('token');
    localStorage.removeItem('auth_user');   // â† ã“ã£ã¡ãŒæ­£
    location.href = './index.html';
  });

  loadProfile();
</script>
</body>
</html>
