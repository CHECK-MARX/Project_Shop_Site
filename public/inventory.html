<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>åœ¨åº«ç®¡ç† - Vulnerable Shop</title>
  <div id="invMsg" class="muted" style="margin:8px 0;"></div>
  <link rel="stylesheet" href="./styles.css" />

  <!-- ã“ã®ãƒšãƒ¼ã‚¸å°‚ç”¨ã®è»½é‡ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆä»–ãƒšãƒ¼ã‚¸ã¸ã¯å½±éŸ¿ã—ãªã„ã‚ˆã† #invPage ã§ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰ -->
  <style>
    #invPage .card { padding: 12px; }
    #invPage table.table { width:100%; border-collapse: separate; border-spacing: 0 10px; }
    #invPage thead th {
      font-weight: 700;
      opacity: .9;
      text-align: left;
      padding: 10px 12px;
    }
    #invPage tbody tr {
      background: #0f1b31;          /* æ—¢å­˜ãƒ†ãƒ¼ãƒã®ã‚«ãƒ¼ãƒ‰è‰²ã«åˆã‚ã›ã‚‹ */
      border: 1px solid #27334d;
      border-radius: 12px;
    }
    /* ä¸¸è§’ã‚’åŠ¹ã‹ã›ã‚‹ãŸã‚ã«ã‚»ãƒ«å´ã«ä½™ç™½ã‚’å…¥ã‚Œã‚‹ */
    #invPage tbody td { padding: 10px 12px; }
    #invPage tbody tr > td:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
    #invPage tbody tr > td:last-child  { border-top-right-radius:12px; border-bottom-right-radius:12px; }

    /* å…¥åŠ› */
    #invPage input.num-in, #invPage input.add-in {
      width: 100%;
      height: 38px;
      background: #0b1426;
      border: 1px solid #2c3a59;
      color: #eaf2ff;
      border-radius: 10px;
      padding: 6px 10px;
      outline: none;
    }
    #invPage .right { text-align: right; }

    /* ãƒŸãƒ‹ãƒœã‚¿ãƒ³ï¼ˆ+1 +5 +10ï¼‰ */
    #invPage .btn.mini {
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 10px;
      background: #1b2741;
      border: 1px solid #2c3a59;
    }
    #invPage .btn.mini:hover { filter: brightness(1.1); }

    /* ä¿å­˜/è¿½åŠ ãƒœã‚¿ãƒ³ã®é«˜ã•ã‚’å…¥åŠ›ã¨åˆã‚ã›ã‚‹ */
    #invPage .btn.btn-secondary.save,
    #invPage .btn.btn-success {
      height: 38px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      padding: 0 14px;
    }

    /* ã‚»ãƒ«å†…ã®æ¨ªä¸¦ã³ */
    #invPage .row { display: flex; gap: 6px; align-items: center; }
    #invPage .stock-cell { font-variant-numeric: tabular-nums; }
    #invPage .sold-link { opacity: .85; }
    #invPage .sold-link b { font-variant-numeric: tabular-nums; }
    #invPage .sold-link:hover { text-decoration: underline; cursor: pointer; }

    /* å¹…ã®æœ€é©åŒ–ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ½°ã‚Œãªã„ã‚ˆã†ã€æœ€å°å¹…ã‚’æŒ‡å®šï¼‰ */
    #invPage th:nth-child(1), #invPage td:nth-child(1) { width: 70px; }
    #invPage th:nth-child(3), #invPage td:nth-child(3) { width: 160px; }
    #invPage th:nth-child(4), #invPage td:nth-child(4) { width: 100px; }
    #invPage th:nth-child(6), #invPage td:nth-child(6) { width: 180px; }
    #invPage th:nth-child(7), #invPage td:nth-child(7) { width: 120px; }
  </style>
</head>
<body>
<header class="navbar">
  <div class="nav-brand"><h1>ğŸ›’ Vulnerable Shop</h1></div>
  <div class="nav-links">
    <a href="./index.html">ãƒ›ãƒ¼ãƒ </a>
    <a href="./products.html">å•†å“</a>
    <a href="./cart.html">ã‚«ãƒ¼ãƒˆ</a>
    <a href="./java-vuln.html" style="color:#ffd700;font-weight:bold;">Javaè„†å¼±æ€§ãƒ‡ãƒ¢</a>
    <div class="auth-buttons">
      <button id="logoutBtn" class="btn btn-danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      <span id="navUser" class="user-pill" hidden></span>
      <a id="profileLink" href="./profile.html" style="display:none;margin-left:8px;">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
    </div>
  </div>
</header>

<main id="invPage" class="container" style="max-width:1100px;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:18px;">
    <h2>åœ¨åº«ç®¡ç†ï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰</h2>
    <a class="btn" href="./sales-history.html">å£²ä¸Šå±¥æ­´ï¼ˆå…¨ä½“ï¼‰</a>
  </div>
  <p class="muted">â€» ä¾¡æ ¼ã¯æ•´æ•°ï¼ˆå††ï¼‰ã§ä¿å­˜ã•ã‚Œã¾ã™ã€‚æ•°é‡ã¯ 0 æœªæº€ã«ã¯ãªã‚Šã¾ã›ã‚“ã€‚</p>

  <div id="invMsg" class="muted" style="margin:8px 0;"></div>

  <div class="card">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>å•†å“å</th>
          <th>ä¾¡æ ¼</th>
          <th>åœ¨åº«</th>
          <th>æ“ä½œï¼å£²ã‚ŒãŸå€‹æ•°</th>
          <th>æ•°é‡</th>
          <th>è¿½åŠ </th>
        </tr>
      </thead>
      <tbody id="invBody"></tbody>
    </table>
  </div>
</main>

<!-- å…±é€šã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script src="./script.js"></script>

<!-- åœ¨åº«ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ©Ÿèƒ½ã¯å‰å›ã¨åŒã˜ï¼‰ -->
<script>
(() => {
  'use strict';
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const esc = s => String(s ?? '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#39;');

  const token = () => localStorage.getItem('token') || '';
  const authHeaders = () => token() ? { Authorization:`Bearer ${token()}` } : {};
  const setMsg = (t, ok=false) => {
    const el = $('#invMsg'); if(!el) return;
    el.textContent = t || '';
    el.className = ok ? 'ok' : (t ? 'err' : 'muted');
  };

  async function ensureAdmin(){
    if (!token()){ setMsg('æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚å³ä¸Šã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚'); return false; }
    try{
      const r = await fetch('/api/me', { headers: authHeaders() });
      if (!r.ok) throw 0;
      const b = await r.json();
      if (!b?.user || b.user.role !== 'admin'){ setMsg('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰'); return false; }
      return true;
    }catch{ setMsg('èªè¨¼ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ'); return false; }
  }

  function rowHTML(p){
    const id    = Number(p.id);
    const name  = esc(p.name || '');
    const price = Math.round(Number(p.price)||0);
    const stock = Math.max(0, Number(p.stock)||0);

    let html  = '<tr data-id="'+id+'">';
    html +=   '<td>'+id+'</td>';
    html +=   '<td><input class="num-in" value="'+name+'" data-k="name"></td>';
    html +=   '<td><input class="num-in" type="number" step="1" value="'+price+'" data-k="price"></td>';
    html +=   '<td class="stock-cell">'+stock+'</td>';
    html +=   '<td>';
    html +=     '<div class="row">';
    html +=       '<button class="btn mini add" data-add="1">+1</button>';
    html +=       '<button class="btn mini add" data-add="5">+5</button>';
    html +=       '<button class="btn mini add" data-add="10">+10</button>';
    html +=       '<span class="sold-link">å£²ã‚ŒãŸ: <b>â€”</b></span>';
    html +=       '<button class="btn btn-secondary save">ä¿å­˜</button>';
    html +=     '</div>';
    html +=   '</td>';
    html +=   '<td class="right"><input class="add-in" type="number" placeholder="0" value="0"></td>';
    html +=   '<td><button class="btn btn-success do-add">è¿½åŠ </button></td>';
    html += '</tr>';
    return html;
  }

  async function loadList(){
    setMsg('');
    const body = $('#invBody'); if (!body) return;
    body.innerHTML = '<tr><td colspan="7" class="muted">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>';
    try{
      const r = await fetch('/api/products');
      if(!r.ok) throw 0;
      const items = await r.json();
      if (!Array.isArray(items) || !items.length){
        body.innerHTML = '<tr><td colspan="7" class="muted">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
        return;
      }
      body.innerHTML = items.map(rowHTML).join('');
      wireRowEvents();
    }catch{
      body.innerHTML = '<tr><td colspan="7" class="err">èª­ã¿è¾¼ã¿å¤±æ•—</td></tr>';
    }
  }

  function wireRowEvents(){
    const body = $('#invBody'); if(!body) return;

    $$('.save', body).forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const tr = e.currentTarget.closest('tr'); if(!tr) return;
        const id = Number(tr.getAttribute('data-id'));
        const name = tr.querySelector('[data-k="name"]').value.trim();
        let price = Math.round(Number(tr.querySelector('[data-k="price"]').value));
        if(!Number.isFinite(price) || price < 0) price = 0;

        try{
          const r = await fetch(`/api/admin/products/${id}`, {
            method:'PUT',
            headers: { 'Content-Type':'application/json', ...authHeaders() },
            body: JSON.stringify({ name, price })
          });
          if (!r.ok) throw 0;
          setMsg('ä¿å­˜ã—ã¾ã—ãŸ', true);
          await loadList();
        }catch{
          setMsg('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      });
    });

    $$('.add', body).forEach(btn=>{
      btn.addEventListener('click', e=>{
        const tr = e.currentTarget.closest('tr'); if(!tr) return;
        const addIn = tr.querySelector('.add-in');
        const add = Number(e.currentTarget.getAttribute('data-add')) || 0;
        const cur = Math.round(Number(addIn.value)||0);
        addIn.value = String(cur + add);
      });
    });

    $$('.do-add', body).forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const tr = e.currentTarget.closest('tr'); if(!tr) return;
        const id = Number(tr.getAttribute('data-id'));
        let add = Math.round(Number(tr.querySelector('.add-in').value));
        if (!Number.isFinite(add)) add = 0;

        try{
          const r = await fetch(`/api/admin/products/${id}/stock/add`, {
            method:'POST',
            headers: { 'Content-Type':'application/json', ...authHeaders() },
            body: JSON.stringify({ add })
          });
          if (!r.ok) throw 0;
          const d = await r.json();
          tr.querySelector('.stock-cell').textContent = String(d.stock ?? '0');
          tr.querySelector('.add-in').value = '0';
          setMsg('åœ¨åº«ã‚’æ›´æ–°ã—ã¾ã—ãŸ', true);
        }catch{
          setMsg('åœ¨åº«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      });
    });

    $$('.sold-link', body).forEach(sp=>{
      sp.addEventListener('click', e=>{
        const tr = e.currentTarget.closest('tr'); if(!tr) return;
        const id = Number(tr.getAttribute('data-id'));
        location.href = `./sales-history.html?product=${encodeURIComponent(id)}`;
      });
    });
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    $('#logoutBtn')?.addEventListener('click', ()=>{
      localStorage.removeItem('token'); localStorage.removeItem('auth_user');
      location.href = './index.html';
    });

    if (!(await ensureAdmin())) return;
    loadList();
  });
})();
</script>
<!-- å…±é€šãƒ˜ãƒ«ãƒ‘ï¼ˆAuth/ãƒˆãƒ¼ã‚¹ãƒˆ/ãƒŠãƒ“åˆ¶å¾¡ç­‰ãŒå…¥ã£ã¦ã„ã‚‹æƒ³å®šï¼‰ -->
<script src="/script.js" defer></script>
<!-- åœ¨åº«ãƒšãƒ¼ã‚¸å°‚ç”¨ -->
<script src="/inventory.js" defer></script>
</body>
</html>
