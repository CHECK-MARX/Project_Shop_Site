<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç®¡ç†è€…ãƒ‘ãƒãƒ« - Vulnerable Shop</title>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    .admin-wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .panel { background: rgba(8,12,26,.6); border:1px solid #27334d; border-radius:12px; padding:16px; }
    .panel + .panel { margin-top: 24px; }
    .panel h2 { margin-bottom:14px; }
    .note { color:#9fb0d4; font-size:12px; margin-top:6px; }
    .input-xs{ height:36px; padding:6px 10px; border-radius:10px; border:1px solid #2c3a59;
               background:#101829; color:#e9edf6; outline:none; width:100%; }
    .input-xs:focus{ border-color:#2d7ef7; box-shadow:0 0 0 3px rgba(45,126,247,.25); }
    .btn-xs{ height:36px; padding:0 12px; border-radius:10px; font-weight:700; }
    .btn-gap{ display:flex; gap:8px; flex-wrap:wrap; }
    .table-wrap { overflow-x:auto; }
    table.table { width:100%; border-collapse:collapse; }
    table.table th, table.table td{ padding:10px 12px; border-bottom:1px solid #223051; }
    table.table th{ text-align:left; color:#c9d4f1; opacity:.9; white-space:nowrap; }
    table.table td.controls{ white-space:nowrap; }
    .w-180 { width:180px; } .w-220 { width:220px; } .w-120 { width:120px; }
    .w-140 { width:140px; } .w-80  { width:80px;  }
    .backup-ops { display:flex; gap:8px; }
  </style>
</head>
<body>
  <header>
    <nav class="navbar">
      <div class="nav-brand"><h1>ğŸ›  ç®¡ç†è€…ãƒ‘ãƒãƒ«</h1></div>
      <div class="nav-links">
        <a href="./index.html">ãƒ›ãƒ¼ãƒ </a>
        <a href="./products.html">å•†å“</a>
        <a href="./cart.html">ã‚«ãƒ¼ãƒˆ</a>
        <button id="logoutBtn" class="btn btn-danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <span id="navUser" class="user-pill" hidden></span>
      </div>
    </nav>
  </header>

  <main class="admin-wrap">
    <section class="panel">
      <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
      <div class="table-wrap">
        <table class="table" id="usersTable">
          <thead>
            <tr>
              <th class="w-80">ID</th>
              <th class="w-140">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
              <th class="w-220">ãƒ¡ãƒ¼ãƒ«</th>
              <th class="w-180">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</th>
              <th class="w-120">æ¨©é™</th>
              <th class="w-180">ä½œæˆæ—¥æ™‚</th>
              <th class="w-180">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="usersTbody"></tbody>
        </table>
      </div>
      <div class="note">â€» root ã¯å‰Šé™¤ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ä¸å¯</div>
    </section>

    <section class="panel">
      <h2>DB ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
      <div class="btn-gap" style="margin-bottom:12px;">
        <input id="backupName" class="input-xs w-220" placeholder="ä»»æ„ã®åå‰ï¼ˆè‹±æ•°-_ï¼‰" />
        <button id="createBackupBtn" class="btn btn-primary btn-xs">DBãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</button>
      </div>

      <div class="table-wrap">
        <table class="table" id="bkTable">
          <thead>
            <tr>
              <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
              <th class="w-180">ã‚µã‚¤ã‚º/ä½œæˆæ—¥æ™‚</th>
              <th class="w-220">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="bkTbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="toaster"></div>
  <script>
    // ç®¡ç†APIç”¨ fetch ãƒ©ãƒƒãƒ‘ï¼ˆå¿…ãš Bearer ã‚’ä»˜ã‘ã‚‹ï¼‰
    async function adminFetch(url, opt={}){
      const token = (window.Auth && Auth.getToken && Auth.getToken()) || localStorage.getItem('token') || '';
      const headers = Object.assign(
        { 'Content-Type':'application/json' },
        opt.headers||{},
        token ? { 'Authorization': `Bearer ${token}` } : {}
      );
      const res = await fetch(url, Object.assign({}, opt, { headers }));
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) throw new Error(data?.error || res.status);
      return data;
    }
  
    // ä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
    async function loadUsers(){
      try {
        const users = await adminFetch('/api/admin/users');
        // ... ã“ã“ã§ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ãã®ã¾ã¾ï¼‰
      } catch (e) {
        console.error(e);
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
  
    // ä¾‹: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§
    async function loadBackups(){
      try {
        const rows = await adminFetch('/api/admin/backups');
        // ... ã“ã“ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¡¨æç”»ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ãã®ã¾ã¾ï¼‰
      } catch (e) {
        console.error(e);
        const box = document.getElementById('bkListNotice');
        if (box) box.textContent = 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ï¼ˆHTTP 500ï¼‰';
      }
    }
  
    document.addEventListener('DOMContentLoaded', ()=>{
      // admin ä»¥å¤–ã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      try { if (!(Auth && Auth.isAdmin && Auth.isAdmin())) location.href = './index.html'; } catch {}
      loadUsers();
      loadBackups();
    });
  </script>
  
  <script>
    // ====== Robust token/user detection ======
    const tokenKeyCandidates = ['token','jwt','jwt_token','authToken','access_token'];
    const userKeyCandidates  = ['user','me','profile'];

    const storageProbe = (keys, src) => {
      for (const k of keys) {
        try {
          const v = src.getItem(k);
          if (v) return v;
        } catch {}
      }
      return '';
    };

    // â˜… æ­£è¦è¡¨ç¾ãªã—ã®å®‰å…¨ãª Cookie å–å¾—
    function readCookie(name){
      const parts = document.cookie ? document.cookie.split(';') : [];
      for (const part of parts){
        const p = part.trim();
        if (!p) continue;
        const eq = p.indexOf('=');
        const key = eq >= 0 ? p.slice(0, eq) : p;
        if (key === name){
          return eq >= 0 ? decodeURIComponent(p.slice(eq+1)) : '';
        }
      }
      return '';
    }

    function detectToken(){
      // localStorage / sessionStorage
      let t = storageProbe(tokenKeyCandidates, localStorage) || storageProbe(tokenKeyCandidates, sessionStorage);
      if (t) return t;
      // cookie
      for (const k of tokenKeyCandidates){
        t = readCookie(k);
        if (t) return t;
      }
      return '';
    }

    function detectUser(){
      for (const k of userKeyCandidates){
        try{
          const v = localStorage.getItem(k) || sessionStorage.getItem(k);
          if (v) return JSON.parse(v);
        }catch{}
      }
      return null;
    }

    const auth = {
      get token(){ return detectToken(); },
      get user(){ return detectUser(); }
    };

    const authHeader = () => auth.token ? { 'Authorization': 'Bearer ' + auth.token } : {};

    function toast(msg){
      let t = document.querySelector('#toaster');
      if(!t){ t=document.createElement('div'); t.id='toaster'; document.body.appendChild(t); }
      const n = document.createElement('div'); n.textContent = msg;
      t.appendChild(n); setTimeout(()=>n.remove(), 1600);
    }

    // ====== Admin guard ======
    async function guardAdmin(){
      const pill = document.querySelector('#navUser');
      if (pill && auth.user?.username){ pill.hidden=false; pill.style.display='inline-block'; pill.textContent = auth.user.username; }

      if (!auth.token){
        location.href='/index.html'; return;
      }
      try{
        const res = await fetch('/api/me', { headers: authHeader() });
        if (!res.ok){ throw new Error('me '+res.status); }
        const j = await res.json();
        if (!j?.user || j.user.role!=='admin'){ location.href='/index.html'; }
      }catch{
        location.href='/index.html';
      }
    }

    // ====== Users ======
    function showUsersErrorRow(message){
      const tb = document.querySelector('#usersTbody');
      tb.innerHTML = `<tr><td colspan="7">${message}</td></tr>`;
    }

    async function loadUsers(){
      const tb = document.querySelector('#usersTbody');
      tb.innerHTML = `<tr><td colspan="7">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>`;
      try{
        const res = await fetch('/api/admin/users', { headers: authHeader() });
        if (!res.ok){
          if (res.status===401 || res.status===403){
            showUsersErrorRow('æ¨©é™ã‚¨ãƒ©ãƒ¼ï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³/ãƒˆãƒ¼ã‚¯ãƒ³ä¸ä¸€è‡´ï¼‰ã€‚ãƒ­ã‚°ã‚¢ã‚¦ãƒˆâ†’å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
          } else {
            showUsersErrorRow('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTP '+res.status+'ï¼‰');
          }
          return;
        }
        const list = await res.json();
        if (!Array.isArray(list) || list.length===0){
          showUsersErrorRow('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return;
        }
        tb.innerHTML = list.map(u=>{
          const isRoot = String(u.username).toLowerCase()==='root';
          const dis = isRoot ? 'disabled' : '';
          const mail = u.email||'';
          const pw   = u.password||'';
          return `
            <tr data-id="${u.id}" data-username="${u.username}">
              <td>${u.id}</td>
              <td>${u.username}</td>
              <td><input class="input-xs email" value="${mail.replace(/"/g,'&quot;')}" ${isRoot?'readonly':''}></td>
              <td><input class="input-xs pass"  value="${pw.replace(/"/g,'&quot;')}" ${isRoot?'readonly':''}></td>
              <td>${u.role}</td>
              <td>${u.created_at||''}</td>
              <td class="controls">
                <div class="btn-gap">
                  <button class="btn btn-info btn-xs edit" ${dis}>ç·¨é›†</button>
                  <button class="btn btn-danger btn-xs del" ${dis}>å‰Šé™¤</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');

        // ç·¨é›†
        document.querySelectorAll('.edit').forEach(b=>b.addEventListener('click', async (e)=>{
          const tr = e.currentTarget.closest('tr');
          const id = +tr.dataset.id;
          const email = tr.querySelector('.email').value.trim();
          const pass  = tr.querySelector('.pass').value;

          let ok1=true, ok2=true;
          if (pass!==''){
            const r1 = await fetch(`/api/admin/users/${id}/password`, {
              method:'PUT',
              headers: { 'Content-Type':'application/json', ...authHeader() },
              body: JSON.stringify({ password: pass })
            }); ok1 = r1.ok;
          }
          try{
            const r2 = await fetch(`/api/admin/users/${id}`, {
              method:'PUT',
              headers: { 'Content-Type':'application/json', ...authHeader() },
              body: JSON.stringify({ email })
            });
            ok2 = r2.ok || r2.status===404 || r2.status===405;
          }catch{}
          toast((ok1&&ok2)?'ä¿å­˜ã—ã¾ã—ãŸ':'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          loadUsers();
        }));

        // å‰Šé™¤
        document.querySelectorAll('.del').forEach(b=>b.addEventListener('click', async (e)=>{
          const tr = e.currentTarget.closest('tr');
          const id = +tr.dataset.id;
          const name = tr.dataset.username;
          if (!confirm(`${name} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
          const r = await fetch(`/api/admin/users/${id}`, { method:'DELETE', headers: authHeader() });
          toast(r.ok?'å‰Šé™¤ã—ã¾ã—ãŸ':'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
          loadUsers();
        }));

      }catch(err){
        console.error(err);
        showUsersErrorRow('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰');
      }
    }

    // ====== Backups ======
    function bkErrorRow(msg){
      const tb = document.querySelector('#bkTbody');
      tb.innerHTML = `<tr><td colspan="3">${msg}</td></tr>`;
    }

    function fmtSize(b){ if (b==null) return '-'; const mb=+b/1024/1024; return (mb<1?(mb*1024).toFixed(0)+' KB':mb.toFixed(2)+' MB'); }

    async function loadBackups(){
      const tb = document.querySelector('#bkTbody');
      tb.innerHTML = `<tr><td colspan="3">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>`;
      try{
        const res = await fetch('/api/admin/backups', { headers: authHeader() });
        if (!res.ok){ bkErrorRow('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ï¼ˆHTTP '+res.status+'ï¼‰'); return; }
        const list = await res.json();
        if (!Array.isArray(list) || list.length===0){ bkErrorRow('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
        tb.innerHTML = list.map(b=>`
          <tr data-name="${b.name}">
            <td>${b.name}</td>
            <td>${fmtSize(b.size)} / ${b.created_at||''}</td>
            <td>
              <div class="backup-ops">
                <button class="btn btn-warning btn-xs restore">ãƒªã‚¹ãƒˆã‚¢</button>
                <button class="btn btn-danger  btn-xs remove">å‰Šé™¤</button>
              </div>
            </td>
          </tr>
        `).join('');

        document.querySelectorAll('.restore').forEach(x=>x.addEventListener('click', async (e)=>{
          const name = e.currentTarget.closest('tr').dataset.name;
          if (!confirm(`${name} ã‚’ãƒªã‚¹ãƒˆã‚¢ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
          const r = await fetch('/api/admin/restore', {
            method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() },
            body: JSON.stringify({ name })
          });
          toast(r.ok?'ãƒªã‚¹ãƒˆã‚¢ã—ã¾ã—ãŸï¼ˆå†èµ·å‹•ãŒå¿…è¦ãªå ´åˆã‚ã‚Šï¼‰':'ãƒªã‚¹ãƒˆã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }));

        document.querySelectorAll('.remove').forEach(x=>x.addEventListener('click', async (e)=>{
          const name = e.currentTarget.closest('tr').dataset.name;
          if (!confirm(`${name} ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
          const r = await fetch(`/api/admin/backups/${encodeURIComponent(name)}`, {
            method:'DELETE', headers: authHeader()
          });
          toast(r.ok?'å‰Šé™¤ã—ã¾ã—ãŸ':'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
          loadBackups();
        }));

      }catch{
        bkErrorRow('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰');
      }
    }

    async function createBackup(){
      const name = document.querySelector('#backupName').value.trim();
      const r = await fetch('/api/backup', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', ...authHeader() },
        body: JSON.stringify({ backupName: name || 'backup' })
      });
      toast(r.ok?'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ':'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      loadBackups();
    }

    // ====== boot ======
    document.addEventListener('DOMContentLoaded', async ()=>{
      await guardAdmin();

      document.querySelector('#logoutBtn')?.addEventListener('click', ()=>{
        // å¯èƒ½æ€§ã®ã‚ã‚‹ã‚­ãƒ¼ã‚’ç·æƒé™¤
        [...tokenKeyCandidates, ...userKeyCandidates].forEach(k=>{
          localStorage.removeItem(k); sessionStorage.removeItem(k);
        });
        // cookie ã‚‚æƒé™¤
        document.cookie.split(';').forEach(c=>{
          const [n] = c.split('=');
          if (n && tokenKeyCandidates.includes(n.trim())){
            document.cookie = n.trim()+'=; Max-Age=0; path=/';
          }
        });
        location.href='/index.html';
      });

      loadUsers();
      loadBackups();
      document.querySelector('#createBackupBtn')?.addEventListener('click', createBackup);
    });
  </script>
</body>
</html>
