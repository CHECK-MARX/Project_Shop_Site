<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç®¡ç†è€…ãƒšãƒ¼ã‚¸ - Vulnerable Shop</title>
  <link rel="stylesheet" href="./styles.css"/>
  <style>
    .user-pill{display:inline-flex;align-items:center;gap:6px;margin-left:10px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);font-weight:600;letter-spacing:.02em}
    .admin-wrap{max-width:1200px;margin:36px auto 80px;padding:0 16px}
    .admin-head{display:flex;align-items:center;gap:14px;margin-bottom:16px}
    .danger{display:none;margin-bottom:12px;color:#ff6b6b}
    .note{display:none;margin-bottom:12px;color:#cfe0ff}
    .admin-table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
    .admin-table thead th{background:#0f1b31;color:#cfe0ff;text-align:left;font-weight:700;padding:12px 14px;border-bottom:1px solid #27334d}
    .admin-table tbody td{padding:12px 14px;border-bottom:1px solid #1f2a44;vertical-align:middle}
    .muted{opacity:.7}
    .actions{display:flex;gap:8px}
    .btn-xs{height:32px;padding:0 10px;font-size:12px}
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal{position:fixed;inset:0;display:none;place-items:center;padding:24px;z-index:1000}
    .modal.open{display:grid}
    .modal::before{content:"";position:absolute;inset:0;background:rgba(5,10,20,.64);backdrop-filter:blur(3px)}
    .modal-card{position:relative;z-index:1;width:min(92vw,420px);border:1px solid #27334d;border-radius:14px;padding:18px;background:linear-gradient(180deg,rgba(29,37,61,.96),rgba(18,24,42,.96));color:#e9edf6}
    .modal-card h3{margin:0 0 12px;font-size:16px}
    .modal-card label{font-size:12px;opacity:.9}
    .modal-card input{width:100%;height:40px;margin:6px 0 14px;padding:10px 12px;border-radius:10px;border:1px solid #2c3a59;background:#101829;color:#e9edf6}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end}
  </style>
</head>
<body>
<header>
  <nav class="navbar">
    <div class="nav-brand"><h1>ğŸ›’ Vulnerable Shop</h1></div>
    <div class="nav-links">
      <a href="./index.html">ãƒ›ãƒ¼ãƒ </a>
      <a href="./products.html">å•†å“</a>
      <a href="./cart.html">ã‚«ãƒ¼ãƒˆ</a>
      <a href="./java-vuln.html" style="color:#ffd700;font-weight:bold;">Javaè„†å¼±æ€§ãƒ‡ãƒ¢</a>
      <div class="auth-buttons">
        <button id="logoutBtn" class="btn btn-danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <span id="navUser" class="user-pill"></span>
    </div>
  </nav>
</header>

<main class="admin-wrap">
  <div class="admin-head">
    <h2>ç®¡ç†è€…ãƒšãƒ¼ã‚¸ï¼ˆç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ / ãƒ¡ãƒ¼ãƒ« / ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰</h2>
    <span class="muted">â€» æ•™è‚²ç”¨ã«ã¤ãæ©Ÿå¾®æƒ…å ±ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™</span>
  </div>

  <div id="errorBox" class="danger"></div>
  <div id="demoNote" class="note"></div>

  <div class="table-wrap">
    <table class="admin-table" id="usersTable" aria-label="ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§">
      <thead>
        <tr>
          <th style="width:82px">ID</th>
          <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
          <th>ãƒ¡ãƒ¼ãƒ«</th>
          <th>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</th>
          <th style="width:120px">ãƒ­ãƒ¼ãƒ«</th>
          <th style="width:200px">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="usersBody">
        <tr><td colspan="6" class="muted">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>
      </tbody>
    </table>
  </div>
</main>

<!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="pwdModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <h3 id="pwdTitle">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
    <div>
      <label for="pwdInput">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input id="pwdInput" type="password" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
    </div>
    <div class="modal-actions">
      <button id="pwdCancel" class="btn btn-secondary btn-xs">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="pwdSave" class="btn btn-primary btn-xs">ä¿å­˜</button>
    </div>
  </div>
</div>

<script src="./script.js"></script>
<script>
  const $ = s => document.querySelector(s);
  const token = localStorage.getItem('token');
  const user  = JSON.parse(localStorage.getItem('user') || 'null');

  function showUserPill(){
    const pill = $('#navUser');
    pill.textContent = user?.username ? 'ğŸ‘¤ ' + user.username : 'ğŸ‘¤ æœªãƒ­ã‚°ã‚¤ãƒ³';
  }
  function showErr(msg){ const b=$('#errorBox'); b.textContent=msg; b.style.display='block'; }
  function clearErr(){ const b=$('#errorBox'); b.textContent=''; b.style.display='none'; }

  async function fetchUsers(){
    const resp = await fetch('/api/admin/users', {
      headers:{ Authorization:'Bearer ' + token }
    });
    if(!resp.ok){
      let txt = '';
      try { txt = (await resp.json()).error; } catch {}
      throw new Error(txt || resp.statusText);
    }
    return resp.json();
  }

  function renderUsers(list){
    const tb = $('#usersBody');
    if(!Array.isArray(list) || list.length===0){
      tb.innerHTML = '<tr><td colspan="6" class="muted">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }
    const rows = list.map(u=>{
      const isRoot = String(u.username).toLowerCase()==='root';
      const editDis = isRoot ? 'disabled title="root ã¯ç·¨é›†ã§ãã¾ã›ã‚“"' : '';
      const delDis  = isRoot ? 'disabled title="root ã¯å‰Šé™¤ã§ãã¾ã›ã‚“"' : '';
      return `
        <tr>
          <td>${u.id ?? ''}</td>
          <td>${u.username ?? ''}</td>
          <td>${u.email ?? ''}</td>
          <td>${u.password ?? '(ä¸æ˜)'}</td>
          <td>${u.role ?? ''}</td>
          <td class="actions">
            <button class="btn btn-secondary btn-xs" data-action="edit" data-id="${u.id}" data-name="${u.username}" ${editDis}>ç·¨é›†</button>
            <button class="btn btn-danger btn-xs"    data-action="del"  data-id="${u.id}" data-name="${u.username}" ${delDis}>å‰Šé™¤</button>
          </td>
        </tr>`;
    }).join('');
    tb.innerHTML = rows;
  }

  async function load(){
    clearErr();
    $('#usersBody').innerHTML = '<tr><td colspan="6" class="muted">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>';
    try{
      const list = await fetchUsers();
      renderUsers(list);
    }catch(e){
      renderUsers([]);
      showErr('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
    }
  }

  // ---- å‰Šé™¤/ç·¨é›†ãƒãƒ³ãƒ‰ãƒ© ----
  $('#usersTable').addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button[data-action]');
    if(!btn || btn.disabled) return; // disabledã¯ç„¡è¦–
    const id   = btn.getAttribute('data-id');
    const name = btn.getAttribute('data-name');
    const act  = btn.getAttribute('data-action');

    if(act === 'del'){
      if(!confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${name}ã€(ID:${id}) ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      try{
        const r = await fetch('/api/admin/users/' + id, {
          method:'DELETE',
          headers:{ Authorization:'Bearer ' + token }
        });
        const d = await r.json().catch(()=>({}));
        if(!r.ok) throw new Error(d.error || r.statusText);
        alert('å‰Šé™¤ã—ã¾ã—ãŸ');
        load();
      }catch(e){
        alert('å‰Šé™¤ã«å¤±æ•—: ' + e.message);
      }
    }

    if(act === 'edit'){
      openPwdModal({ id, name });
    }
  });

  // ---- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« ----
  let editingUser = null;
  function openPwdModal(u){
    editingUser = u;
    $('#pwdTitle').textContent = `ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´: ${u.name} (ID:${u.id})`;
    $('#pwdInput').value = '';
    $('#pwdModal').classList.add('open');
    $('#pwdModal').setAttribute('aria-hidden', 'false');
  }
  function closePwdModal(){
    $('#pwdModal').classList.remove('open');
    $('#pwdModal').setAttribute('aria-hidden', 'true');
    editingUser = null;
  }
  $('#pwdCancel').addEventListener('click', closePwdModal);

  $('#pwdSave').addEventListener('click', async ()=>{
    const pw = $('#pwdInput').value;
    if(!pw){ alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    try{
      const r = await fetch('/api/admin/users/' + editingUser.id + '/password', {
        method:'PUT',
        headers:{
          'Content-Type':'application/json',
          Authorization:'Bearer ' + token
        },
        body: JSON.stringify({ password: pw })
      });
      const d = await r.json().catch(()=>({}));
      if(!r.ok) throw new Error(d.error || r.statusText);
      closePwdModal();
      alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      load();
    }catch(e){
      alert('æ›´æ–°ã«å¤±æ•—: ' + e.message);
    }
  });

  // ---- ç”»é¢èµ·å‹• ----
  document.getElementById('logoutBtn')?.addEventListener('click', ()=>{
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    location.href = './index.html';
  });
  showUserPill();
  load();
</script>
</body>
</html>
