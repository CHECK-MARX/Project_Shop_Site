<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ç®¡ç†è€…ãƒ‘ãƒãƒ« - Vulnerable Shop</title>
  <link rel="stylesheet" href="./styles.css"/>
  <style>
    .guard {max-width:960px;margin:24px auto;padding:16px;border:1px solid #27334d;border-radius:12px;background:#0f162b;color:#e9edf6}
    .table {width:100%;border-collapse:collapse;margin-top:12px}
    .table th,.table td{border-bottom:1px solid rgba(255,255,255,.1);padding:10px;text-align:left}
    .table th{opacity:.8}
  </style>
</head>
<body>
<header>
  <nav class="navbar">
    <div class="nav-brand"><h1>ğŸ›  ç®¡ç†è€…ãƒ‘ãƒãƒ«</h1></div>
    <div class="nav-links">
      <a href="./index.html">ãƒ›ãƒ¼ãƒ </a>
      <a href="./products.html">å•†å“</a>
      <a href="./cart.html">ã‚«ãƒ¼ãƒˆ</a>
      <div class="auth-buttons">
        <button id="logoutBtn" class="btn btn-danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>
  </nav>
</header>

<main>
  <section class="admin-section" style="margin-top:16px">
    <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
    <div id="adminInfo" class="guard">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="adminContent" class="admin-content" style="margin-top:16px">
      <table class="table" id="usersTable">
        <thead><tr><th>ID</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th><th>ãƒ¡ãƒ¼ãƒ«</th><th>æ¨©é™</th><th>ä½œæˆæ—¥æ™‚</th></tr></thead>
        <tbody id="usersBody"></tbody>
      </table>
    </div>

    <div class="admin-controls">
      <button id="backupBtn" class="btn btn-info">DBãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</button>
      <button id="debugBtn" class="btn btn-warning">ãƒ‡ãƒãƒƒã‚°æƒ…å ±</button>
    </div>

    <pre id="debugOut" class="guard" style="display:none;"></pre>
  </section>
</main>

<script>
  // è»½ã„ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  const jget=(k,f=null)=>{try{return JSON.parse(localStorage.getItem(k)||'null')??f;}catch{return f;}};
  const token=localStorage.getItem('token');
  const user =jget('user',null);

  // 1) ã‚¬ãƒ¼ãƒ‰ï¼šãƒˆãƒ¼ã‚¯ãƒ³ç„¡ã—/ç®¡ç†è€…ã§ãªã‘ã‚Œã°ãƒ›ãƒ¼ãƒ ã¸
  async function guard(){
    const info = document.getElementById('adminInfo');
    if(!token || !user){ info.textContent='æœªãƒ­ã‚°ã‚¤ãƒ³ã®ãŸã‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚'; setTimeout(()=>location.href='./index.html',900); return false; }

    // ã‚µãƒ¼ãƒå´åˆ¤å®šã«ä»»ã›ã‚‹ãŒã€æ—©æœŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨ã—ã¦ãƒ­ãƒ¼ãƒ«ã‚‚è¦‹ã¦ãŠã
    if((user.role||'')!=='admin'){ info.textContent='ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚'; setTimeout(()=>location.href='./index.html',900); return false; }

    info.textContent='ç®¡ç†è€…ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ' + (user.username||'');
    return true;
  }

  // 2) ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®å–å¾—
  async function loadUsers(){
    const body = document.getElementById('usersBody');
    body.innerHTML = '<tr><td colspan="5">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
    try{
      const r = await fetch('/api/admin/users', { headers:{Authorization:'Bearer '+token}});
      const data = await r.json();
      if(!r.ok) throw new Error(data.error||r.status);
      body.innerHTML = (data||[]).map(u=>`
        <tr>
          <td>${u.id}</td>
          <td>${u.username}</td>
          <td>${u.email||''}</td>
          <td>${u.role||''}</td>
          <td>${u.created_at||''}</td>
        </tr>
      `).join('');
    }catch(e){
      body.innerHTML = `<tr><td colspan="5" style="color:#ff9999">å–å¾—å¤±æ•—: ${String(e)}</td></tr>`;
    }
  }

  // 3) ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/ãƒ‡ãƒãƒƒã‚°
  document.getElementById('backupBtn')?.addEventListener('click', async ()=>{
    const name = 'backup_'+Date.now();
    try{
      const r = await fetch('/api/backup', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({backupName:name})});
      const d = await r.json();
      alert(r.ok ? `ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ: ${name}.db` : `å¤±æ•—: ${d.error||r.status}`);
    }catch(e){ alert('ã‚¨ãƒ©ãƒ¼: '+e.message); }
  });

  document.getElementById('debugBtn')?.addEventListener('click', async ()=>{
    const out = document.getElementById('debugOut');
    try{
      const r = await fetch('/api/debug');
      const d = await r.json();
      out.style.display='block';
      out.textContent = JSON.stringify(d, null, 2);
    }catch(e){
      out.style.display='block';
      out.textContent = 'å–å¾—å¤±æ•—: '+e.message;
    }
  });

  // 4) ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  document.getElementById('logoutBtn')?.addEventListener('click', ()=>{
    localStorage.removeItem('token'); localStorage.removeItem('user');
    location.href='./index.html';
  });

  (async ()=>{
    if(await guard()) await loadUsers();
  })();
</script>
</body>
</html>
