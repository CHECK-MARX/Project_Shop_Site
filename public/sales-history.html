<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å£²ä¸Šå±¥æ­´ï¼ˆå…¨ä½“ï¼‰</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="navbar">
    <div class="nav-brand"><h1>ğŸ›’ Vulnerable Shop</h1></div>
    <div class="nav-links">
      <a href="./index.html">ãƒ›ãƒ¼ãƒ </a>
      <a href="./products.html">å•†å“</a>
      <a href="./cart.html">ã‚«ãƒ¼ãƒˆ</a>
      <a href="./admin.html">ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
      <a href="./inventory.html">åœ¨åº«ç®¡ç†</a>
    </div>
    <div class="auth-buttons">
      <a class="btn btn-ghost btn-sm" href="./inventory.html">â† åœ¨åº«ç®¡ç†ã¸æˆ»ã‚‹</a>
    </div>
  </header>

  <main class="admin-section" style="max-width:1280px;margin:0 auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin:14px 0 10px;">
      <h2>å£²ä¸Šå±¥æ­´ï¼ˆå…¨ä½“ï¼‰</h2>
      <div class="btn-group">
        <button id="btnReload" class="btn btn-ghost btn-sm">æœ€æ–°ã‚’å†å–å¾—</button>
      </div>
    </div>
    <p class="muted">ç›´è¿‘ã®å£²ä¸Šã‚’æ–°ã—ã„é †ã«è¡¨ç¤ºã—ã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦åœ¨åº«ç®¡ç†ã®ã€Œå£²ã‚ŒãŸã€åˆè¨ˆã¨ç…§åˆã§ãã¾ã™ã€‚</p>

    <!-- æ¤œç´¢ãƒãƒ¼ -->
    <div class="search-container" style="max-width:100%;margin-top:12px;gap:8px;display:grid;grid-template-columns:1fr 1fr 140px 140px auto auto;">
      <input id="qUser" class="search-input" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆusername / email éƒ¨åˆ†ä¸€è‡´ï¼‰" />
      <input id="qProduct" class="search-input" placeholder="å•†å“åï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰" />
      <input id="qMin" class="search-input" type="number" min="0" placeholder="é‡‘é¡ï¼ˆä»¥ä¸Šï¼‰" />
      <input id="qMax" class="search-input" type="number" min="0" placeholder="é‡‘é¡ï¼ˆä»¥ä¸‹ï¼‰" />
      <button id="btnSearch" class="btn btn-primary">æ¤œç´¢</button>
      <button id="btnClear" class="btn btn-secondary">ã‚¯ãƒªã‚¢</button>
    </div>

    <!-- ä»¶æ•°è¡¨ç¤º -->
    <div id="hitInfo" class="muted" style="margin:10px 2px;"></div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="inv-table-wrap" style="margin-top:8px;">
      <table class="table" id="salesTable">
        <thead>
          <tr>
            <th style="width:160px;">æ—¥æ™‚</th>
            <th style="width:180px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
            <th>å•†å“å</th>
            <th style="width:90px;text-align:right;">æ•°é‡</th>
            <th style="width:120px;text-align:right;">å˜ä¾¡</th>
            <th style="width:140px;text-align:right;">å°è¨ˆï¼ˆè¡Œï¼‰</th>
            <th style="width:120px;text-align:center;">æ³¨æ–‡ID</th>
          </tr>
        </thead>
        <tbody id="salesBody"></tbody>
      </table>
    </div>

    <div style="display:flex;justify-content:center;margin:16px 0 28px;">
      <button id="btnMore" class="btn btn-ghost btn-sm" hidden>ã•ã‚‰ã«èª­ã¿è¾¼ã‚€</button>
    </div>
  </main>

  <script src="./script.js" defer></script>
  <script>
    (function(){
      'use strict';
      const body   = document.getElementById('salesBody');
      const hit    = document.getElementById('hitInfo');
      const more   = document.getElementById('btnMore');
      const reload = document.getElementById('btnReload');

      const qUser    = document.getElementById('qUser');
      const qProduct = document.getElementById('qProduct');
      const qMin     = document.getElementById('qMin');
      const qMax     = document.getElementById('qMax');
      const btnSearch= document.getElementById('btnSearch');
      const btnClear = document.getElementById('btnClear');

      // â˜… åˆæœŸã¯ã€Œå…¨ä»¶è¡¨ç¤ºã€ãƒ¢ãƒ¼ãƒ‰
      const page = { all:true, limit:100, offset:0, lastCount:0, filters:{} };

      function fmt(n){ try{ return window.fmtJPY ? fmtJPY(n) : ('Â¥'+(Math.round(n||0)).toLocaleString('ja-JP')); }catch{ return n; } }
      const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

      function readFilters(){
        const f = {};
        const u = qUser.value.trim();    if (u) f.user = u;
        const p = qProduct.value.trim(); if (p) f.product = p;
        const mi= qMin.value.trim();     if (mi !== '') f.min = Math.max(0, parseInt(mi,10)||0);
        const ma= qMax.value.trim();     if (ma !== '') f.max = Math.max(0, parseInt(ma,10)||0);
        return f;
      }

      function buildQS(obj){
        const u = new URLSearchParams();
        if (page.all) {
          u.set('all','1'); // â† å…¨ä»¶ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚µãƒ¼ãƒå´ã§ LIMIT/OFFSET ç„¡åŠ¹ï¼‰
        } else {
          u.set('limit', String(page.limit));
          u.set('offset', String(page.offset));
        }
        for (const [k,v] of Object.entries(obj||{})) if (v !== undefined && v !== null && v!=='') u.set(k, String(v));
        return u.toString();
      }

      async function fetchSales(opts={}){
        const append = !!opts.append;
        const qs = buildQS(page.filters);
        try{
          const headers = {};
          if (window.Auth?.getToken) {
            const t = Auth.getToken() || '';
            if (t) headers.Authorization = 'Bearer ' + t;
          }
          const r = await fetch('/api/admin/sales-timeline?' + qs, { headers });
          if (!r.ok) throw new Error('HTTP '+r.status);
          const rows = await r.json();
          page.lastCount = rows.length;

          if (!append) body.innerHTML = '';

          for (const it of rows){
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${esc(it.created_at || '')}</td>
              <td>${esc(it.user || '')}</td>
              <td>${esc(it.product || '')}</td>
              <td style="text-align:right;">${Number(it.qty||0).toLocaleString('ja-JP')}</td>
              <td style="text-align:right;">${fmt(it.unit||0)}</td>
              <td style="text-align:right;font-weight:700;">${fmt(it.line||0)}</td>
              <td style="text-align:center;font-family:monospace;">${esc(it.orderRef || '')}</td>
            `;
            body.appendChild(tr);
          }

          const loaded = body.children.length;
          hit.textContent = page.all
            ? `è¡¨ç¤ºä»¶æ•°: ${loaded.toLocaleString('ja-JP')}ï¼ˆå…¨ä»¶è¡¨ç¤ºï¼‰`
            : `è¡¨ç¤ºä»¶æ•°: ${loaded.toLocaleString('ja-JP')}${rows.length < page.limit ? 'ï¼ˆæœ«å°¾ã¾ã§åˆ°é”ï¼‰' : ''}`;

          more.hidden   = page.all;
          more.disabled = page.all || rows.length < page.limit;
        }catch(e){
          console.error(e);
          body.innerHTML = `<tr><td colspan="7" class="muted">å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™ãŒå¿…è¦ãªå¯èƒ½æ€§ï¼‰</td></tr>`;
          hit.textContent = '';
          more.hidden = true;
        }
      }

      function doSearch(){
        page.offset = 0;
        page.filters = readFilters();
        // æ¤œç´¢ã—ã¦ã‚‚åŸºæœ¬ã¯å…¨ä»¶è¡¨ç¤ºã‚’ç¶­æŒï¼ˆãƒ•ã‚£ãƒ«ã‚¿å¾Œã®å…¨ä»¶ï¼‰
        page.all = true;
        fetchSales({ append:false });
      }
      function loadMore(){
        if (page.all) return;
        page.offset += page.limit;
        fetchSales({ append:true });
      }
      function clearFilters(){
        qUser.value = qProduct.value = qMin.value = qMax.value = '';
        doSearch();
      }

      btnSearch.addEventListener('click', doSearch);
      btnClear .addEventListener('click', clearFilters);
      more     .addEventListener('click', loadMore);
      reload   .addEventListener('click', ()=>{ page.offset = 0; fetchSales({ append:false }); });
      [qUser,qProduct,qMin,qMax].forEach(el=> el.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); }));

      // åˆæœŸãƒ­ãƒ¼ãƒ‰ï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç„¡ã—ã§å…¨ä»¶
      page.filters = {};
      page.all = true;
      fetchSales({ append:false });
    })();
  </script>
</body>
</html>
