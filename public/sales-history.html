<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>å£²ä¸Šå±¥æ­´ï¼ˆå…¨ä½“ï¼‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./styles.css">
  <style>
    .admin-section{max-width:1280px;margin:0 auto;padding:24px 20px;}
    .muted{opacity:.8}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);white-space:nowrap}
    .right{text-align:right}
    .center{text-align:center}
    .toolbar{display:flex;justify-content:flex-end;margin-bottom:12px}
  </style>
</head>
<body>
<header class="navbar">
  <div class="nav-brand"><h1>ğŸ›’ Vulnerable Shop</h1></div>
  <div class="nav-links">
    <a href="./index.html">ãƒ›ãƒ¼ãƒ </a>
    <a href="./products.html">å•†å“</a>
    <a href="./cart.html">ã‚«ãƒ¼ãƒˆ</a>
    <a href="./admin.html" id="navAdmin">ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
    <a href="./inventory.html" id="navInventory">åœ¨åº«ç®¡ç†</a>
  </div>
  <div class="auth-buttons">
    <a id="profileLink" href="./profile.html" class="btn btn-secondary" style="display:none;margin-right:8px;">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
    <span id="navUser" class="user-pill" hidden></span>
    <button id="logoutBtn" class="btn btn-danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</header>

<main class="admin-section">
  <div class="toolbar">
    <a href="./inventory.html" class="btn btn-ghost">â† åœ¨åº«ç®¡ç†ã¸æˆ»ã‚‹</a>
  </div>

  <h2>å£²ä¸Šå±¥æ­´ï¼ˆå…¨ä½“ï¼‰</h2>
  <p class="muted">ç›´è¿‘ã®å£²ä¸Šã‚’æ–°ã—ã„é †ã«è¡¨ç¤ºã—ã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦åœ¨åº«ç®¡ç†ã®ã€Œå£²ã‚ŒãŸã€åˆè¨ˆã¨ç…§åˆã§ãã¾ã™ã€‚</p>

  <div id="msg" class="muted" style="margin:8px 0 12px;"></div>

  <div class="inv-table-wrap">
    <table class="table" id="histTable">
      <thead>
        <tr>
          <th>æ—¥æ™‚</th>
          <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
          <th>å•†å“å</th>
          <th class="right">æ•°é‡</th>
          <th class="right">å˜ä¾¡</th>
          <th class="right">å°è¨ˆ</th>
          <th>æ³¨æ–‡ID</th>
        </tr>
      </thead>
      <tbody id="histBody"></tbody>
    </table>
  </div>

  <div style="margin-top:14px">
    <button id="moreBtn" class="btn btn-secondary btn-sm">ã•ã‚‰ã«èª­ã¿è¾¼ã‚€</button>
  </div>
</main>

<script src="./script.js" defer></script>
<script>
(() => {
  const $  = (s, r=document) => r.querySelector(s);
  const fmtJPY = window.fmtJPY || (n => `Â¥${Math.round(Number(n||0)).toLocaleString('ja-JP')}`);

  let offset = 0;
  const limit  = 50;

  async function loadPage() {
    const body = $('#histBody');
    const msg  = $('#msg');
    msg.textContent = '';

    try {
      const rows = await window.apiAuthGet(`/api/admin/sales-timeline?limit=${limit}&offset=${offset}`);
      if (!Array.isArray(rows)) throw new Error('bad');

      if (rows.length === 0 && offset === 0) {
        msg.textContent = 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
        return;
      }
      const html = rows.map(r => {
        const dt = new Date(r.created_at || Date.now());
        const when = `${dt.getFullYear()}/${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
        return `<tr>
          <td>${when}</td>
          <td>${(r.user||'').replace(/</g,'&lt;')}</td>
          <td>${(r.product||'').replace(/</g,'&lt;')}</td>
          <td class="right">${r.qty}</td>
          <td class="right">${fmtJPY(r.unit)}</td>
          <td class="right">${fmtJPY(r.line)}</td>
          <td><code>${(r.orderRef||'').replace(/</g,'&lt;')}</code></td>
        </tr>`;
      }).join('');
      body.insertAdjacentHTML('beforeend', html);
      offset += rows.length;

      // è¿½åŠ ãƒ‡ãƒ¼ã‚¿ãŒlimitæœªæº€ãªã‚‰ãƒœã‚¿ãƒ³ã‚’éš ã™
      if (rows.length < limit) $('#moreBtn').style.display = 'none';
    } catch (e) {
      console.error(e);
      // 401/403/404 ãªã©
      $('#moreBtn').style.display = 'none';
      msg.textContent = 'å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™ãŒå¿…è¦ãªå¯èƒ½æ€§ï¼‰';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // ãƒŠãƒ“ã®ç®¡ç†ãƒªãƒ³ã‚¯ã‚’å®‰å…¨ã«æ›´æ–°ï¼ˆscript.js å´ã®é–¢æ•°ï¼‰
    window.updateAdminNav?.();
    loadPage();
    $('#moreBtn').addEventListener('click', loadPage);
  });
})();
</script>
</body>
</html>
