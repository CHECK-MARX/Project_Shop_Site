<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ±ºæ¸ˆ - Vulnerable Shop</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header class="navbar">
    <div class="nav-brand"><h1>ğŸ›’ Vulnerable Shop</h1></div>
    <div class="nav-links">
      <a href="/">ãƒ›ãƒ¼ãƒ </a>
      <a href="/products.html">å•†å“</a>
      <a href="/cart.html">ã‚«ãƒ¼ãƒˆ</a>
      <a href="/checkout.html">æ±ºæ¸ˆ</a>
    </div>
  </header>
  <main class="cart-section" style="max-width:640px;">
    <h2>æ±ºæ¸ˆæƒ…å ±</h2>
    <div id="msg"></div>
    <form id="pay" class="cart-items">
      <div class="form-group"><label>æ°å</label><input id="name" required></div>
      <div class="form-group"><label>ã‚«ãƒ¼ãƒ‰ç•ªå·</label><input id="card" required></div>
      <div class="form-group"><label>æœ‰åŠ¹æœŸé™ (MM/YY)</label><input id="exp" required></div>
      <div class="form-group"><label>CVV</label><input id="cvv" required></div>
      <button class="btn btn-success" type="submit">æ”¯æ‰•ã†</button>
    </form>
  </main>
  <script>
    function show(m,t='info'){ document.getElementById('msg').innerHTML = `<div class="alert alert-${t}">${m}</div>` }
    async function total(){ const cart=JSON.parse(localStorage.getItem('cart')||'[]'); let s=0; for(const it of cart){ const p=await (await fetch('/api/product/'+it.productId)).json(); s+=p.price*it.quantity } return s }
    document.getElementById('pay').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = { name: name.value, cardNumber: card.value, expiry: exp.value, cvv: cvv.value, total: await total() };
      const r = await fetch('/api/checkout', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      const d = await r.json();
      if(!r.ok){ show('æ±ºæ¸ˆå¤±æ•—: '+(d.error||'unknown'), 'danger'); return; }
      show(`æ±ºæ¸ˆå®Œäº†: åˆè¨ˆ <b>Â¥${d.total}</b> / åç¾© <i>${d.name}</i>`, 'success');
      localStorage.removeItem('cart');
    });
  </script>
</body>
</html>

